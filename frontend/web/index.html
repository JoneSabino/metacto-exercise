<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-g">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Voting System</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f4f6f8;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    main {
      width: 100%;
      max-width: 800px;
    }

    h1,
    h2 {
      color: #1a1a1a;
      text-align: center;
    }

    form {
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 12px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    #features-list {
      display: grid;
      gap: 20px;
    }

    .feature-card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .feature-details {
      flex-grow: 1;
    }

    .feature-card h3 {
      margin: 0 0 8px 0;
    }

    .feature-card p {
      margin: 0;
      color: #666;
    }

    .vote-section {
      text-align: center;
      flex-shrink: 0;
      min-width: 80px;
    }

    .vote-count {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .vote-button {
      background-color: #28a745;
      padding: 8px 16px;
      font-size: 14px;
    }

    .vote-button:hover {
      background-color: #1e7e34;
    }

    #status-message {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
      display: none;
      /* Hidden by default */
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
  </style>
</head>

<body>

  <main>
    <h1>Feature Suggestions</h1>

    <div id="status-message"></div>

    <section id="submission-form">
      <h2>Submit a New Feature</h2>
      <form id="new-feature-form">
        <input type="text" id="feature-title" placeholder="Feature Title" required>
        <textarea id="feature-description" placeholder="Describe the feature..." required></textarea>
        <button type="submit">Submit Feature</button>
      </form>
    </section>

    <section>
      <h2>Current Features</h2>
      <div id="features-list">
      </div>
    </section>
  </main>

  <script>
    // --- CONFIGURATION ---
    // IMPORTANT: Replace this with your actual Render API URL
    const API_BASE_URL = 'https://featurevote-api.onrender.com';

    // --- DOM ELEMENTS ---
    const featureForm = document.getElementById('new-feature-form');
    const featuresList = document.getElementById('features-list');
    const statusMessageDiv = document.getElementById('status-message');

    /**
     * Generates and stores a unique identifier for the user/device in localStorage.
     * This helps prevent duplicate votes from the same browser.
     * @returns {string} The user's unique identifier.
     */
    function getUserIdentifier() {
      let userId = localStorage.getItem('featureVoteUserId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('featureVoteUserId', userId);
      }
      console.log("User Identifier:", userId);
      return userId;
    }

    /**
     * Displays a status message to the user.
     * @param {string} message - The message to display.
     * @param {boolean} isError - If true, styles the message as an error.
     */
    function showStatusMessage(message, isError = false) {
      statusMessageDiv.textContent = message;
      statusMessageDiv.className = isError ? 'status-error' : 'status-success';
      // Hide the message after 5 seconds
      setTimeout(() => {
        statusMessageDiv.className = '';
        statusMessageDiv.style.display = 'none';
      }, 5000);
    }

    /**
     * Fetches all features from the backend and renders them to the page.
     */
    async function fetchAndRenderFeatures() {
      try {
        const response = await fetch(`${API_BASE_URL}/features`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const features = await response.json();
        console.log("Fetched features:", features);

        // Clear the current list
        featuresList.innerHTML = '';

        if (features.length === 0) {
          featuresList.innerHTML = '<p>No features submitted yet. Be the first!</p>';
          return;
        }

        // Sort features by vote count descending
        features.sort((a, b) => b.votes - a.votes);

        // Render each feature
        features.forEach(feature => {
          const card = document.createElement('div');
          card.className = 'feature-card';
          card.innerHTML = `
                        <div class="feature-details">
                            <h3>${feature.title}</h3>
                            <p>${feature.description || 'No description provided.'}</p>
                        </div>
                        <div class="vote-section">
                            <div class="vote-count">${feature.votes}</div>
                            <button class="vote-button" data-feature-id="${feature.id}">Vote</button>
                        </div>
                    `;
          featuresList.appendChild(card);
        });

      } catch (error) {
        console.error("Failed to fetch features:", error);
        showStatusMessage("Could not load features from the server.", true);
      }
    }

    /**
     * Handles the submission of the new feature form.
     * @param {Event} event - The form submission event.
     */
    async function handleFormSubmit(event) {
      event.preventDefault();
      const titleInput = document.getElementById('feature-title');
      const descriptionInput = document.getElementById('feature-description');

      const featureData = {
        title: titleInput.value.trim(),
        description: descriptionInput.value.trim()
      };

      if (!featureData.title) {
        showStatusMessage("Title is required.", true);
        return;
      }

      console.log("Submitting new feature:", featureData);

      try {
        const response = await fetch(`${API_BASE_URL}/features`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(featureData),
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        showStatusMessage("Feature submitted successfully!");
        featureForm.reset();
        await fetchAndRenderFeatures(); // Refresh the list

      } catch (error) {
        console.error("Failed to submit feature:", error);
        showStatusMessage("Failed to submit feature. Please try again.", true);
      }
    }

    /**
     * Handles clicks on vote buttons.
     * @param {Event} event - The click event.
     */
    async function handleVoteClick(event) {
      if (event.target.classList.contains('vote-button')) {
        const featureId = event.target.dataset.featureId;
        console.log(`Voting for feature ID: ${featureId}`);

        try {
          const response = await fetch(`${API_BASE_URL}/features/${featureId}/vote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_identifier: getUserIdentifier() }),
          });

          const result = await response.json();

          if (!response.ok) {
            // Use the server's message (e.g., "Already voted.")
            throw new Error(result.detail || `Server error: ${response.status}`);
          }

          showStatusMessage("Vote registered!");
          await fetchAndRenderFeatures(); // Refresh to show new vote count

        } catch (error) {
          console.error("Failed to vote:", error);
          showStatusMessage(`Could not register vote: ${error.message}`, true);
        }
      }
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      // Check if the API URL has been set
      if (API_BASE_URL === 'YOUR_RENDER_API_URL_HERE') {
        alert('Please update the API_BASE_URL in the script tag with your Render API URL.');
        showStatusMessage("Configuration needed: Please set your API URL in the HTML file.", true);
        return;
      }

      // Initial load of features
      fetchAndRenderFeatures();

      // Attach event listeners
      featureForm.addEventListener('submit', handleFormSubmit);
      featuresList.addEventListener('click', handleVoteClick); // Use event delegation for vote buttons
    });

  </script>
</body>

</html>